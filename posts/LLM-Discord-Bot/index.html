<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.313">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Hamza">
<meta name="dcterms.date" content="2023-11-06">

<title>Hamza’s Blog - Create a LLM-powered Discord Bot</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-RL9R6GRFLC"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-RL9R6GRFLC', { 'anonymize_ip': true});
</script>


</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">Hamza’s Blog</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/HaoES"><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/0Kiriyama"><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/hamza-es/"><i class="bi bi-linkedin" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#prerequisites" id="toc-prerequisites" class="nav-link active" data-scroll-target="#prerequisites">1. Prerequisites:</a>
  <ul class="collapse">
  <li><a href="#tools" id="toc-tools" class="nav-link" data-scroll-target="#tools">1.1 Tools:</a></li>
  <li><a href="#the-model" id="toc-the-model" class="nav-link" data-scroll-target="#the-model">1.2 The Model:</a></li>
  <li><a href="#setting-up-the-project-files" id="toc-setting-up-the-project-files" class="nav-link" data-scroll-target="#setting-up-the-project-files">1.3 Setting up the project files:</a></li>
  </ul></li>
  <li><a href="#using-the-model" id="toc-using-the-model" class="nav-link" data-scroll-target="#using-the-model">2. Using the Model:</a>
  <ul class="collapse">
  <li><a href="#chat.py" id="toc-chat.py" class="nav-link" data-scroll-target="#chat.py">2.1 <code>chat.py</code></a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Create a LLM-powered Discord Bot</h1>
  <div class="quarto-categories">
    <div class="quarto-category">llm</div>
    <div class="quarto-category">ml</div>
    <div class="quarto-category">nlp</div>
  </div>
  </div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Hamza </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">November 6, 2023</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<p>In this blog post we are going to build an LLM-powered Discord Bot using <code>llama.cpp</code>, here are the steps we are going to follow: 1. Download a LLM from huggingface 2. Setup a REST API to use this model 3. Create a Discord Bot Application 4. Use the REST API to operate the bot</p>
<p>This is a beginner friendly tutorial and assumes only basic knowledge of Python and Linux. I will be working in Ubuntu 20.04 installed on <a href="https://learn.microsoft.com/en-us/windows/wsl/install">WSL2</a> but any other Linux distribution should work too.</p>
<section id="prerequisites" class="level1">
<h1>1. Prerequisites:</h1>
<section id="tools" class="level2">
<h2 class="anchored" data-anchor-id="tools">1.1 Tools:</h2>
<p>Let’s start first with an update to <code>apt</code> to get the latest metadata for Ubuntu packages. Open your Linux/WSL2 terminal and type the following command:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1"></a>sudo apt<span class="op">-</span>get update</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now let’s install some packages that we’re going to need.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1"></a>sudo apt<span class="op">-</span>get install python3<span class="op">-</span>virtualenv python3<span class="op">-</span>pip curl jq </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><code>virtualenv</code> is a tool to create isolated Python environments. It creates a folder which contains all the necessary executables to use the packages that a Python project would need. It’s better to create a virtual environment for each project so that even if we mess up our installations, the mess wouldn’t spread to all of the system.<br>
</li>
<li><code>pip</code> is the standard package manager for Python is pip . It allows you to install and manage packages that aren’t part of the Python standard library.</li>
<li><code>curl</code> curl (short for “Client URL”) is a command line tool that enables data transfer over various network protocols. It communicates with a web or application server by specifying a relevant URL and the data that need to be sent or received.</li>
<li><code>jq</code> is a lightweight and flexible command-line JSON processor that we will use to parse and format replies from our API.<br>
Now that we installed <code>pip</code> let’s install more tools that we’re going to need:</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1"></a>pip install discord.py python<span class="op">-</span>dotenv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li><code>discord.py</code> is a Python library that exhaustively implements Discord’s APIs in an efficient and Pythonic way. This includes utilizing Python’s implementation of Async IO.</li>
<li><code>python-dotenv</code> eads key-value pairs from a . env file and can set them as environment variables. It helps in the development of applications following the 12-factor principles.</li>
</ul>
</section>
<section id="the-model" class="level2">
<h2 class="anchored" data-anchor-id="the-model">1.2 The Model:</h2>
<p>We are going to use <code>llama.cpp</code> so you should download a model that is compatible with it. You can browse <a href="https://huggingface.co">HuggingFace</a> and check the model card to see if it is compatible with <code>llama.cpp</code>. Another way is to download models with the <code>GGUF</code> extension.</p>
<p>I am going to be using the <code>Llama-2-7B-Chat-GGUF</code> by TheBloke available <a href="https://huggingface.co/TheBloke/Llama-2-7B-Chat-GGUF">here</a>.<br>
In the model card we can see that there are many versions of that model, the difference between each version is the quantisation method, you can see the size of each version and how much RAM it needs to operate. I downloaded the <code>llama-2-7b-chat.Q5_K_M.gguf</code> version.</p>
<p>To download a model you must go to the <a href="https://huggingface.co/TheBloke/Llama-2-7B-Chat-GGUF/tree/main">Files and Versions Tab</a> and right-click on the model you want then choose <code>Copy Link</code>.<br>
Now type you can download using the <code>wget</code> command in the terminal like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1"></a>wget https:<span class="op">//</span>huggingface.co<span class="op">/</span>TheBloke<span class="op">/</span>Llama<span class="op">-</span><span class="dv">2</span><span class="op">-</span><span class="dv">7</span><span class="er">B</span><span class="op">-</span>Chat<span class="op">-</span>GGUF<span class="op">/</span>resolve<span class="op">/</span>main<span class="op">/</span>llama<span class="op">-</span><span class="dv">2</span><span class="op">-</span><span class="dv">7</span><span class="er">b</span><span class="op">-</span>chat.Q5_K_M.gguf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If you don’t have <code>wget</code> already installed, you can install it by simply typing:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1"></a>sudo apt<span class="op">-</span>get install wget</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If you want a better quality of replies and also have the adequate hardware for it, you can download larger models (i.e.&nbsp;13B and higher).</p>
</section>
<section id="setting-up-the-project-files" class="level2">
<h2 class="anchored" data-anchor-id="setting-up-the-project-files">1.3 Setting up the project files:</h2>
<p>Now let’s create a directory for our project.<br>
We can do that by the following command:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1"></a>mkdir discord<span class="op">-</span>llm<span class="op">-</span>bot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now let’s access our newly created folder using:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1"></a>cd discord<span class="op">-</span>llm<span class="op">-</span>bot</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We create a virtual environment that we will call <code>env</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1"></a>virtualenv env</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Once created, we need to activate our environment</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1"></a>source env<span class="op">/</span><span class="bu">bin</span><span class="op">/</span>activate</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You will see now that your terminal has a <code>(env)</code> it means that your virtual environment is active.<br>
We will be using <a href="https://github.com/abetlen/llama-cpp-python">Python bindings</a> for <a href="https://github.com/ggerganov/llama.cpp">LLAMA-CPP</a>. In the <a href="https://github.com/abetlen/llama-cpp-python">Python bindings</a> page, go down to the <code>Web Server</code> section and use the following command to install the Python Bindings:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1"></a>pip install <span class="st">"llama-cpp-python[server]"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="using-the-model" class="level1">
<h1>2. Using the Model:</h1>
<p>Now let’s load our downloaded model. To do so we use the following command:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1"></a>python3 <span class="op">-</span>m llama_cpp.server <span class="op">--</span>model <span class="op">~/</span>llama<span class="op">-</span><span class="dv">2</span><span class="op">-</span><span class="dv">7</span><span class="er">b</span><span class="op">-</span>chat.Q5_K_M.gguf</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Here I am using the <code>llama-2-7b-chat.Q5_K_M.gguf</code> model, which I downloaded to my home folder hence the <code>~</code> in the path. So the command above must point to the <code>gguf</code> file of the model you downloaded. After running that command you should get a result on the terminal similar to this:</p>
<pre><code>INFO:     Started server process [3414]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
INFO:     Uvicorn running on http://localhost:8000 (Press CTRL+C to quit)</code></pre>
<p>Let’s now navigate to <a href="http://localhost:8000/docs">http://localhost:8000/docs</a> to the OpenAPI schemas.<br>
Since we are building a ChatBot what interests us is the POST request for creating chat completion.<br>
Click on <code>/v1/chat/completions</code> and copy the code from the <code>Example Value</code> field.</p>
<p>The code is:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1"></a>{</span>
<span id="cb13-2"><a href="#cb13-2"></a>  <span class="st">"messages"</span>: [</span>
<span id="cb13-3"><a href="#cb13-3"></a>    {</span>
<span id="cb13-4"><a href="#cb13-4"></a>      <span class="st">"content"</span>: <span class="st">"You are a helpful assistant."</span>,</span>
<span id="cb13-5"><a href="#cb13-5"></a>      <span class="st">"role"</span>: <span class="st">"system"</span></span>
<span id="cb13-6"><a href="#cb13-6"></a>    },</span>
<span id="cb13-7"><a href="#cb13-7"></a>    {</span>
<span id="cb13-8"><a href="#cb13-8"></a>      <span class="st">"content"</span>: <span class="st">"What is the capital of France?"</span>,</span>
<span id="cb13-9"><a href="#cb13-9"></a>      <span class="st">"role"</span>: <span class="st">"user"</span></span>
<span id="cb13-10"><a href="#cb13-10"></a>    }</span>
<span id="cb13-11"><a href="#cb13-11"></a>  ]</span>
<span id="cb13-12"><a href="#cb13-12"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Go back to your terminal and in a new tab (because the first one is still running your model, do not touch it) create a new file in your project directory, name it <code>payload.json</code>.<br>
I use neovim, you can use your preferred text editor.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1"></a>nvim payload.json</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>paste the code you copied from the docs into the newly created <code>json</code> file, there are two message objects in the code we copied, one where the <code>role</code> is <code>system</code> and the other where the <code>role</code> is <code>user</code>.<br>
We won’t need the one for <code>system</code> since we are not aiming to modify the model’s behavior so let’s delete it.<br>
The code should now look like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1"></a>{</span>
<span id="cb15-2"><a href="#cb15-2"></a>  <span class="st">"messages"</span>: [</span>
<span id="cb15-3"><a href="#cb15-3"></a>    {</span>
<span id="cb15-4"><a href="#cb15-4"></a>      <span class="st">"content"</span>: <span class="st">"What is the capital of France?"</span>,</span>
<span id="cb15-5"><a href="#cb15-5"></a>      <span class="st">"role"</span>: <span class="st">"user"</span></span>
<span id="cb15-6"><a href="#cb15-6"></a>    }</span>
<span id="cb15-7"><a href="#cb15-7"></a>  ]</span>
<span id="cb15-8"><a href="#cb15-8"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>for the <code>user</code> message we need the change the query string to match the prompt supported by our model, we can do this by adding <code>### Response:</code> at the end of the <code>content</code> field.</p>
<p>The code should look like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1"></a>{</span>
<span id="cb16-2"><a href="#cb16-2"></a>  <span class="st">"messages"</span>: [</span>
<span id="cb16-3"><a href="#cb16-3"></a>    {</span>
<span id="cb16-4"><a href="#cb16-4"></a>      <span class="st">"content"</span>: <span class="st">"What is the capital of France? ### Response: "</span>,</span>
<span id="cb16-5"><a href="#cb16-5"></a>      <span class="st">"role"</span>: <span class="st">"user"</span></span>
<span id="cb16-6"><a href="#cb16-6"></a>    }</span>
<span id="cb16-7"><a href="#cb16-7"></a>  ]</span>
<span id="cb16-8"><a href="#cb16-8"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We are good to go! Save and Close your file <code>ESC</code>+<code>:qw</code> if you are using vim/neovim ;)<br>
Now let’s test our model. Write the following command in the terminal</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1"></a>curl http:<span class="op">//</span>localhost:<span class="dv">8000</span><span class="op">/</span>v1<span class="op">/</span>chat<span class="op">/</span>completions <span class="op">-</span>d <span class="op">@</span>payload.json <span class="op">-</span>H <span class="st">"Content-Type: application/json"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>It may take a while to give a result Then it should outputs you a response like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1"></a>{<span class="st">"id"</span>:<span class="st">"chatcmpl-e219bd31-4515-4f1c-bc57-ea0d4e4f4907"</span>,<span class="st">"object"</span>:<span class="st">"chat.completion"</span>,<span class="st">"created"</span>:<span class="dv">1699287163</span>,<span class="st">"model"</span>:<span class="st">"/home/llama-2-7b-chat.Q5_K_M.gguf"</span>,<span class="st">"choices"</span>:[{<span class="st">"index"</span>:<span class="dv">0</span>,<span class="st">"message"</span>:{<span class="st">"role"</span>:<span class="st">"assistant"</span>,<span class="st">"content"</span>:<span class="st">" The capital of France is Paris."</span>},<span class="st">"finish_reason"</span>:<span class="st">"stop"</span>}],<span class="st">"usage"</span>:{<span class="st">"prompt_tokens"</span>:<span class="dv">35</span>,<span class="st">"completion_tokens"</span>:<span class="dv">7</span>,<span class="st">"total_tokens"</span>:<span class="dv">42</span>}}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>It may take a while to give a result Then it should outputs you a response like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1"></a>{<span class="st">"id"</span>:<span class="st">"chatcmpl-e219bd31-4515-4f1c-bc57-ea0d4e4f4907"</span>,<span class="st">"object"</span>:<span class="st">"chat.completion"</span>,<span class="st">"created"</span>:<span class="dv">1699287163</span>,<span class="st">"model"</span>:<span class="st">"/home/llama-2-7b-chat.Q5_K_M.gguf"</span>,<span class="st">"choices"</span>:[{<span class="st">"index"</span>:<span class="dv">0</span>,<span class="st">"message"</span>:{<span class="st">"role"</span>:<span class="st">"assistant"</span>,<span class="st">"content"</span>:<span class="st">" The capital of France is Paris."</span>},<span class="st">"finish_reason"</span>:<span class="st">"stop"</span>}],<span class="st">"usage"</span>:{<span class="st">"prompt_tokens"</span>:<span class="dv">35</span>,<span class="st">"completion_tokens"</span>:<span class="dv">7</span>,<span class="st">"total_tokens"</span>:<span class="dv">42</span>}}<span class="op">%</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can see in the <code>content</code> field that our model got the right response <code>" The capital of France is Paris."</code><br>
We can see this more clearly if we format the output of our model using <code>jq</code> by piping it at the end of the <code>curl</code> request like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1"></a>curl http:<span class="op">//</span>localhost:<span class="dv">8000</span><span class="op">/</span>v1<span class="op">/</span>chat<span class="op">/</span>completions <span class="op">-</span>d <span class="op">@</span>payload.json <span class="op">-</span>H <span class="st">"Content-Type: application/json"</span> <span class="op">|</span> jq</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You will get a better formatted and more readable result like this one:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1"></a>{</span>
<span id="cb21-2"><a href="#cb21-2"></a>  <span class="st">"id"</span>: <span class="st">"chatcmpl-a326fe62-8e64-4d12-b21d-84eecb18fe71"</span>,</span>
<span id="cb21-3"><a href="#cb21-3"></a>  <span class="st">"object"</span>: <span class="st">"chat.completion"</span>,</span>
<span id="cb21-4"><a href="#cb21-4"></a>  <span class="st">"created"</span>: <span class="dv">1699287412</span>,</span>
<span id="cb21-5"><a href="#cb21-5"></a>  <span class="st">"model"</span>: <span class="st">"/home/llama-2-7b-chat.Q5_K_M.gguf"</span>,</span>
<span id="cb21-6"><a href="#cb21-6"></a>  <span class="st">"choices"</span>: [</span>
<span id="cb21-7"><a href="#cb21-7"></a>    {</span>
<span id="cb21-8"><a href="#cb21-8"></a>      <span class="st">"index"</span>: <span class="dv">0</span>,</span>
<span id="cb21-9"><a href="#cb21-9"></a>      <span class="st">"message"</span>: {</span>
<span id="cb21-10"><a href="#cb21-10"></a>        <span class="st">"role"</span>: <span class="st">"assistant"</span>,</span>
<span id="cb21-11"><a href="#cb21-11"></a>        <span class="st">"content"</span>: <span class="st">" The capital of France is Paris."</span></span>
<span id="cb21-12"><a href="#cb21-12"></a>      },</span>
<span id="cb21-13"><a href="#cb21-13"></a>      <span class="st">"finish_reason"</span>: <span class="st">"stop"</span></span>
<span id="cb21-14"><a href="#cb21-14"></a>    }</span>
<span id="cb21-15"><a href="#cb21-15"></a>  ],</span>
<span id="cb21-16"><a href="#cb21-16"></a>  <span class="st">"usage"</span>: {</span>
<span id="cb21-17"><a href="#cb21-17"></a>    <span class="st">"prompt_tokens"</span>: <span class="dv">35</span>,</span>
<span id="cb21-18"><a href="#cb21-18"></a>    <span class="st">"completion_tokens"</span>: <span class="dv">7</span>,</span>
<span id="cb21-19"><a href="#cb21-19"></a>    <span class="st">"total_tokens"</span>: <span class="dv">42</span></span>
<span id="cb21-20"><a href="#cb21-20"></a>  }</span>
<span id="cb21-21"><a href="#cb21-21"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now let’s ask it for something more complex, let’s go back and edit our prompt in the <code>payload.json</code> file:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1"></a>{</span>
<span id="cb22-2"><a href="#cb22-2"></a>    <span class="st">"messages"</span>: [</span>
<span id="cb22-3"><a href="#cb22-3"></a>        {</span>
<span id="cb22-4"><a href="#cb22-4"></a>            <span class="st">"content"</span>: <span class="st">"Tell me what quantum physics is about? ### Response: "</span>,</span>
<span id="cb22-5"><a href="#cb22-5"></a>            <span class="st">"role"</span>: <span class="st">"user"</span></span>
<span id="cb22-6"><a href="#cb22-6"></a>        }</span>
<span id="cb22-7"><a href="#cb22-7"></a>    ]</span>
<span id="cb22-8"><a href="#cb22-8"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Save the file and run the same curl command again (use the up arrow in keyboard the retrieve old commands in the terminal)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1"></a>curl http:<span class="op">//</span>localhost:<span class="dv">8000</span><span class="op">/</span>v1<span class="op">/</span>chat<span class="op">/</span>completions <span class="op">-</span>d <span class="op">@</span>pl.json <span class="op">-</span>H <span class="st">"Content-Type: application/json"</span> <span class="op">|</span> jq</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The output is:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1"></a>{</span>
<span id="cb24-2"><a href="#cb24-2"></a>  <span class="st">"id"</span>: <span class="st">"chatcmpl-cadcbf3f-e72b-4934-b1c5-5e761547e9ef"</span>,</span>
<span id="cb24-3"><a href="#cb24-3"></a>  <span class="st">"object"</span>: <span class="st">"chat.completion"</span>,</span>
<span id="cb24-4"><a href="#cb24-4"></a>  <span class="st">"created"</span>: <span class="dv">1699289318</span>,</span>
<span id="cb24-5"><a href="#cb24-5"></a>  <span class="st">"model"</span>: <span class="st">"/home/llama-2-7b-chat.Q5_K_M.gguf"</span>,</span>
<span id="cb24-6"><a href="#cb24-6"></a>  <span class="st">"choices"</span>: [</span>
<span id="cb24-7"><a href="#cb24-7"></a>    {</span>
<span id="cb24-8"><a href="#cb24-8"></a>      <span class="st">"index"</span>: <span class="dv">0</span>,</span>
<span id="cb24-9"><a href="#cb24-9"></a>      <span class="st">"message"</span>: {</span>
<span id="cb24-10"><a href="#cb24-10"></a>        <span class="st">"role"</span>: <span class="st">"assistant"</span>,</span>
<span id="cb24-11"><a href="#cb24-11"></a>        <span class="st">"content"</span>: <span class="st">" Quantum physics, also known as quantum mechanics, is a branch of physics"</span></span>
<span id="cb24-12"><a href="#cb24-12"></a>      },</span>
<span id="cb24-13"><a href="#cb24-13"></a>      <span class="st">"finish_reason"</span>: <span class="st">"length"</span></span>
<span id="cb24-14"><a href="#cb24-14"></a>    }</span>
<span id="cb24-15"><a href="#cb24-15"></a>  ],</span>
<span id="cb24-16"><a href="#cb24-16"></a>  <span class="st">"usage"</span>: {</span>
<span id="cb24-17"><a href="#cb24-17"></a>    <span class="st">"prompt_tokens"</span>: <span class="dv">37</span>,</span>
<span id="cb24-18"><a href="#cb24-18"></a>    <span class="st">"completion_tokens"</span>: <span class="dv">16</span>,</span>
<span id="cb24-19"><a href="#cb24-19"></a>    <span class="st">"total_tokens"</span>: <span class="dv">53</span></span>
<span id="cb24-20"><a href="#cb24-20"></a>  }</span>
<span id="cb24-21"><a href="#cb24-21"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The reply that our model gave (which is found in the <code>content</code> field) is short, the model stopped before giving the whole answer, we can know the reason why by looking at the <code>finish_reason</code> field, we see that the reason is <code>length</code>.<br>
This is due to the maximum token length which is set by default to 16.<br>
We can change this in the body of the query by editing the <code>payload.json</code> like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1"></a>{</span>
<span id="cb25-2"><a href="#cb25-2"></a>    <span class="st">"max_tokens"</span>:<span class="dv">512</span>,</span>
<span id="cb25-3"><a href="#cb25-3"></a>    <span class="st">"messages"</span>: [</span>
<span id="cb25-4"><a href="#cb25-4"></a>        {</span>
<span id="cb25-5"><a href="#cb25-5"></a>            <span class="st">"content"</span>: <span class="st">"Tell me what quantum physics is about? ### Response: "</span>,</span>
<span id="cb25-6"><a href="#cb25-6"></a>            <span class="st">"role"</span>: <span class="st">"user"</span></span>
<span id="cb25-7"><a href="#cb25-7"></a>        }</span>
<span id="cb25-8"><a href="#cb25-8"></a>    ]</span>
<span id="cb25-9"><a href="#cb25-9"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Save and run the curl command again, now we have a longer (and much slower) response:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>{ “id”: “chatcmpl-17562ec9-6e71-4b0b-8057-b63db37b165f”, “object”: “chat.completion”, “created”: 1699290401, “model”: “/home/llama-2-7b-chat.Q5_K_M.gguf”, “choices”: [ { “index”: 0, “message”: { “role”: “assistant”, “content”: ” Quantum physics, also known as quantum mechanics, is a branch of physics that explores the behavior of matter and energy at the smallest scales, at which the classical laws of physics no longer apply. At these scales, the principles of quantum mechanics govern the behavior of particles and systems, leading to phenomena such as superposition, entanglement, and wave-particle duality.physics is based on the idea that particles, such as electrons and photons, can exist in multiple states simultaneously, a concept known as superposition. This means that a quantum particle can be in more than one place at the same time, or have more than one set of properties, such as spin or energy, at the same time.fundamental aspect of quantum physics is entanglement, which occurs when two or more particles become connected in such a way that their properties are correlated, regardless of the distance between them. This means that if something happens to one particle, it will instantly affect the other entangled particles, regardless of how far apart they are.one of the most counterintuitive aspects of quantum physics is wave-particle duality. According to this principle, particles can exhibit both wave-like and particle-like behavior depending on how they are observed. This means that a quantum particle can display properties of a wave, such as diffraction and interference, or properties of a particle, such as having definite position and momentum.physics has many practical applications in technology, including transistors, lasers, and computer chips. It also has the potential to revolutionize fields such as medicine, energy production, and materials science. However, quantum physics is still an area of ongoing research and debate, with many unanswered questions and unresolved paradoxes.summary, quantum physics is a branch of physics that explores the behavior of matter and energy at the smallest scales, where the classical laws of physics no longer apply. It is based on principles such as superposition, entanglement, and wave-particle duality, which lead to counterintuitive phenomena and have many practical applications in technology and other fields.” }, “finish_reason”: “stop” } ], “usage”: { “prompt_tokens”: 37, “completion_tokens”: 453, “total_tokens”: 490 } }</p>
<pre><code></code></pre>
</div>
<section id="chat.py" class="level2">
<h2 class="anchored" data-anchor-id="chat.py">2.1 <code>chat.py</code></h2>
<p>Writing <code>curl</code> requests each time is tedious, let’s write a script to do make life easier for us:</p>
<p>For our script we will use the <a href="https://docs.aiohttp.org/en/stable/client_quickstart.html">aiohttp</a>. The quickstart example is enough for what we want to do.<br>
Let’s copy the imports and the first example into our new script file that we will create in our project directory and we will call it <code>chat.py</code>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1"></a>nvim chat.py</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now when we paste the imports and first example our file is like that:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1"></a><span class="im">import</span> aiohttp</span>
<span id="cb29-2"><a href="#cb29-2"></a><span class="im">import</span> asyncio</span>
<span id="cb29-3"><a href="#cb29-3"></a><span class="cf">async</span> <span class="kw">def</span> main():</span>
<span id="cb29-4"><a href="#cb29-4"></a>    <span class="cf">async</span> <span class="cf">with</span> aiohttp.ClientSession() <span class="im">as</span> session:</span>
<span id="cb29-5"><a href="#cb29-5"></a>        <span class="cf">async</span> <span class="cf">with</span> session.get(<span class="st">'http://httpbin.org/get'</span>) <span class="im">as</span> resp:</span>
<span id="cb29-6"><a href="#cb29-6"></a>            <span class="bu">print</span>(resp.status)</span>
<span id="cb29-7"><a href="#cb29-7"></a>            <span class="bu">print</span>(<span class="cf">await</span> resp.text())</span>
<span id="cb29-8"><a href="#cb29-8"></a></span>
<span id="cb29-9"><a href="#cb29-9"></a>asyncio.run(main())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We must modify few things to make this work: First we create the following variables: must use a POST request instead of a GET request in line 5.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1"></a>API_URL <span class="op">=</span> <span class="st">'http://localhost:8000/v1/chat/completions'</span></span>
<span id="cb30-2"><a href="#cb30-2"></a>payload <span class="op">=</span> {</span>
<span id="cb30-3"><a href="#cb30-3"></a>    <span class="st">"max_tokens"</span>:<span class="dv">512</span>,</span>
<span id="cb30-4"><a href="#cb30-4"></a>    <span class="st">"messages"</span>: [</span>
<span id="cb30-5"><a href="#cb30-5"></a>        {</span>
<span id="cb30-6"><a href="#cb30-6"></a>            <span class="st">"content"</span>: <span class="st">"Tell me what quantum physics is about? ### Response: "</span>,</span>
<span id="cb30-7"><a href="#cb30-7"></a>            <span class="st">"role"</span>: <span class="st">"user"</span></span>
<span id="cb30-8"><a href="#cb30-8"></a>        }</span>
<span id="cb30-9"><a href="#cb30-9"></a>    ]</span>
<span id="cb30-10"><a href="#cb30-10"></a>}</span>
<span id="cb30-11"><a href="#cb30-11"></a>headers <span class="op">=</span> {<span class="st">"Content-Type"</span>:<span class="st">"application/json"</span>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Then we need to use a POST request instead of a GET request and we also need to specify our <code>API_URL</code>, <code>headers</code>, and <code>payload</code> like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1"></a><span class="cf">async</span> <span class="cf">with</span> session.get(API_URL, data <span class="op">=</span> payload, headers <span class="op">=</span> headers) <span class="im">as</span> resp:</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now in order for our payload to get parsed correctly we need to dump it as a string for the data argument so we <code>import json</code> and use <code>data = json.dumps(payload)</code> method to do so.</p>
<p>Our <code>chat.py</code> should look like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1"></a><span class="im">import</span> json</span>
<span id="cb32-2"><a href="#cb32-2"></a><span class="im">import</span> aiohttp</span>
<span id="cb32-3"><a href="#cb32-3"></a><span class="im">import</span> asyncio</span>
<span id="cb32-4"><a href="#cb32-4"></a>API_URL <span class="op">=</span> <span class="st">'http://localhost:8000/v1/chat/completions'</span></span>
<span id="cb32-5"><a href="#cb32-5"></a>payload <span class="op">=</span> {</span>
<span id="cb32-6"><a href="#cb32-6"></a>    <span class="st">"max_tokens"</span>:<span class="dv">512</span>,</span>
<span id="cb32-7"><a href="#cb32-7"></a>    <span class="st">"messages"</span>: [</span>
<span id="cb32-8"><a href="#cb32-8"></a>        {</span>
<span id="cb32-9"><a href="#cb32-9"></a>            <span class="st">"content"</span>: <span class="st">"What is the Capital of Japan? ### Response: "</span>,</span>
<span id="cb32-10"><a href="#cb32-10"></a>            <span class="st">"role"</span>: <span class="st">"user"</span></span>
<span id="cb32-11"><a href="#cb32-11"></a>        }</span>
<span id="cb32-12"><a href="#cb32-12"></a>    ]</span>
<span id="cb32-13"><a href="#cb32-13"></a>}</span>
<span id="cb32-14"><a href="#cb32-14"></a>headers <span class="op">=</span> {<span class="st">"Content-Type"</span>:<span class="st">"application/json"</span>}</span>
<span id="cb32-15"><a href="#cb32-15"></a></span>
<span id="cb32-16"><a href="#cb32-16"></a><span class="cf">async</span> <span class="kw">def</span> main():</span>
<span id="cb32-17"><a href="#cb32-17"></a>    <span class="cf">async</span> <span class="cf">with</span> aiohttp.ClientSession() <span class="im">as</span> session:</span>
<span id="cb32-18"><a href="#cb32-18"></a>        <span class="cf">async</span> <span class="cf">with</span> session.post(API_URL, data <span class="op">=</span> json.dumps(payload), headers <span class="op">=</span> headers) <span class="im">as</span> resp:</span>
<span id="cb32-19"><a href="#cb32-19"></a>            <span class="bu">print</span>(resp.status)</span>
<span id="cb32-20"><a href="#cb32-20"></a>            <span class="bu">print</span>(<span class="cf">await</span> resp.text())</span>
<span id="cb32-21"><a href="#cb32-21"></a></span>
<span id="cb32-22"><a href="#cb32-22"></a>asyncio.run(main())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>(I changed the prompt because the one about Quantum Physics takes so much time to respond.) let’s save it and run it:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1"></a>python3 chat.py</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>this gives us the following result:</p>
<p><code>{"id":"chatcmpl-f619a4ee-8509-4029-8b31-20b65db84ffd","object":"chat.completion","created":1699293282,"model":"/home/llama-2-7b-chat.Q5_K_M.gguf","choices":[{"index":0,"message":{"role":"assistant","content":" The capital of Japan is Tokyo."},"finish_reason":"stop"}],"usage":{"prompt_tokens":35,"completion_tokens":7,"total_tokens":42}}</code></p>
<p>Let’s modify our script to print just the desired reply and also so that we don’t have to edit our script each time we want to use a different prompt.</p>
<p>Let’s first see what the script would look like and then explain our changes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1"></a><span class="im">import</span> json</span>
<span id="cb34-2"><a href="#cb34-2"></a><span class="im">import</span> aiohttp</span>
<span id="cb34-3"><a href="#cb34-3"></a><span class="im">import</span> asyncio</span>
<span id="cb34-4"><a href="#cb34-4"></a></span>
<span id="cb34-5"><a href="#cb34-5"></a>API_URL <span class="op">=</span> <span class="st">'http://localhost:8000/v1/chat/completions'</span></span>
<span id="cb34-6"><a href="#cb34-6"></a>headers <span class="op">=</span> {<span class="st">"Content-Type"</span>:<span class="st">"application/json"</span>}</span>
<span id="cb34-7"><a href="#cb34-7"></a></span>
<span id="cb34-8"><a href="#cb34-8"></a><span class="cf">async</span> <span class="kw">def</span> main():</span>
<span id="cb34-9"><a href="#cb34-9"></a>    prompt <span class="op">=</span> <span class="bu">input</span>(<span class="st">"User: "</span>)</span>
<span id="cb34-10"><a href="#cb34-10"></a>    payload <span class="op">=</span> {</span>
<span id="cb34-11"><a href="#cb34-11"></a>        <span class="st">"max_tokens"</span>:<span class="dv">512</span>,</span>
<span id="cb34-12"><a href="#cb34-12"></a>        <span class="st">"messages"</span>: [</span>
<span id="cb34-13"><a href="#cb34-13"></a>            {</span>
<span id="cb34-14"><a href="#cb34-14"></a>                <span class="st">"content"</span>: <span class="ss">f"</span><span class="sc">{</span>prompt<span class="sc">}</span><span class="ss"> ### response: "</span>,</span>
<span id="cb34-15"><a href="#cb34-15"></a>                <span class="st">"role"</span>: <span class="st">"user"</span></span>
<span id="cb34-16"><a href="#cb34-16"></a>                }</span>
<span id="cb34-17"><a href="#cb34-17"></a>            ]</span>
<span id="cb34-18"><a href="#cb34-18"></a>        }</span>
<span id="cb34-19"><a href="#cb34-19"></a>    <span class="cf">async</span> <span class="cf">with</span> aiohttp.ClientSession() <span class="im">as</span> session:</span>
<span id="cb34-20"><a href="#cb34-20"></a>        <span class="cf">async</span> <span class="cf">with</span> session.post(API_URL, data <span class="op">=</span> json.dumps(payload), headers <span class="op">=</span> headers) <span class="im">as</span> resp:</span>
<span id="cb34-21"><a href="#cb34-21"></a>            reply <span class="op">=</span> <span class="cf">await</span> resp.json()</span>
<span id="cb34-22"><a href="#cb34-22"></a>            reply_content <span class="op">=</span> reply[<span class="st">"choices"</span>][<span class="dv">0</span>][<span class="st">"message"</span>][<span class="st">"content"</span>]</span>
<span id="cb34-23"><a href="#cb34-23"></a>            <span class="bu">print</span>(reply_content)</span>
<span id="cb34-24"><a href="#cb34-24"></a></span>
<span id="cb34-25"><a href="#cb34-25"></a>asyncio.run(main())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ul>
<li>First we moved the <code>payload</code> variable into the <code>main()</code> function.</li>
<li>Then we created a new variable <code>prompt</code> that takes the input of the User and uses it as a prompt, you can see that this variable is used in the <code>content</code> field of the <code>payload</code> (line 14).</li>
<li>We modified the print statement in the <code>session</code> (line 21), it is now a variable called <code>reply</code>, this variable contains the whole reply.</li>
<li>We proceed to take only what matters to us (line 22) which is the text in the <code>content</code> field, and we put it in the <code>reply_content</code> variable.<br>
Now let’s save <code>chat.py</code> and run it again with <code>python3 chat.py</code><br>
I gave it the prompt <code>Give me 3 ancient African cities</code> and the output was:</li>
</ul>
<pre><code> Sure! Here are three ancient African cities that were important centers of trade, culture, and civilization:

1. Memphis, Egypt - Founded around 2925 BCE by the pharaoh Narmer, Memphis was the capital of ancient Egypt and one of the most important cities in the ancient world. It was located on the west bank of the Nile River and was known for its impressive architecture, including the Great Sphinx and the Pyramids of Giza.
2. Axum, Ethiopia - Axum was a major center of trade and commerce in ancient Africa, located in what is now modern-day Ethiopia. Founded around 100 CE, it was known for its advanced agriculture, architecture, and engineering. The city was also an important hub for the spread of Christianity throughout East Africa.
3. Timbuktu, Mali - Located in what is now modern-day Mali, Timbuktu was a major center of trade and learning in West Africa during the medieval period. Founded around 1100 CE, it was known for its universities and libraries, which were renowned throughout the Islamic world. The city was also an important center for the production of books and manuscripts.
These three cities were all major centers of trade, culture, and civilization in their respective regions during ancient times, and they played important roles in shaping the history of Africa and the wider world.</code></pre>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://utteranc.es/client.js" repo="HaoES/blogComments" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->



</body></html>